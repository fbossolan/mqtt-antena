{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="flex-row justify-between align-center">
        <h2>Subscription</h2>
        <div>
            <button onclick="clearMessages()" class="btn btn-outline btn-sm">Clear Messages</button>
        </div>
    </div>

    <div class="flex-row" style="gap: 20px; flex-wrap: wrap;">
        <!-- Left: Controls -->
        <div style="flex: 1; min-width: 250px;">
            <form action="{{ url_for('toggle_listen') }}" method="POST" id="subForm">
                <label>Broker:</label>
                <!-- We add onchange to update the UI state to match the selected broker (simple JS for UX) -->
                <select name="broker_id" id="brokerSelect" required onchange="updateFormState()">
                    {% for b in active_brokers %}
                    <option value="{{ b.id }}" data-listening="{{ 'true' if b.is_listening else 'false' }}"
                        data-topic="{{ b.current_topic }}">
                        {{ b.name }} {{ '(Listening)' if b.is_listening else '' }}
                    </option>
                    {% endfor %}
                </select>

                <label>Topic:</label>
                <input type="text" name="topic" id="topicInput" placeholder="Topic (empty = all)">

                <input type="hidden" name="action" id="actionInput" value="start">

                <div class="flex-row mt-1">
                    <button type="submit" class="btn" id="toggleBtn" style="flex:1;">Start Listening</button>
                </div>
            </form>
        </div>

        <!-- Right: Message Log -->
        <div style="flex: 3; min-width: 300px;">
            <div id="connectionStatus" style="font-size: 0.8rem; margin-bottom: 5px; color: #888; display: none;">
                SSE Status: <span id="sseState">Disconnected</span>
            </div>
            <div id="messages"></div>
        </div>
    </div>
</div>


<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const messagesDiv = document.getElementById('messages');
    let socket = null;

    function startStream() {
        if (socket) { return; }
        console.log("Starting Socket.IO connection...");
        document.getElementById('sseState').innerText = "Connecting...";

        // Get the base path from the current location (includes ingress path if present)
        const basePath = window.location.pathname.replace(/\/[^\/]*$/, '') || '';
        const socketPath = basePath + '/socket.io';

        console.log("Socket.IO connecting with path:", socketPath);
        socket = io({
            path: socketPath
        });

        socket.on('connect', function () {
            console.log("Socket.IO Connected");
            document.getElementById('sseState').innerText = "Connected";
            document.getElementById('sseState').style.color = "green";
        });

        socket.on('mqtt_message', function (data) {
            console.log("MQTT Message Received:", data);
            const line = document.createElement('div');
            line.className = 'msg-line';
            line.innerHTML = `<span class="msg-time">[${data.timestamp}]</span> <strong>${data.broker_name}</strong> | ${data.topic}: <span style="color: #fff;">${data.payload}</span>`;
            messagesDiv.appendChild(line);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        socket.on('disconnect', function () {
            console.log("Socket.IO Disconnected");
            document.getElementById('sseState').innerText = "Disconnected";
            document.getElementById('sseState').style.color = "red";
        });

        socket.on('error', function (err) {
            console.error("Socket.IO Error:", err);
        });
    }

    startStream();

    function clearMessages() {
        messagesDiv.innerHTML = '';
    }

    // Dynamic UI update based on selection
    function updateFormState() {
        const select = document.getElementById('brokerSelect');
        if (select.selectedIndex === -1) return;

        // Show/hide SSE Status based on broker selection
        const connectionStatus = document.getElementById('connectionStatus');
        connectionStatus.style.display = select.selectedIndex >= 0 ? 'block' : 'none';

        const option = select.options[select.selectedIndex];
        const isListening = option.getAttribute('data-listening') === 'true';
        const currentTopic = option.getAttribute('data-topic');

        const topicInput = document.getElementById('topicInput');
        const actionInput = document.getElementById('actionInput');
        const btn = document.getElementById('toggleBtn');

        if (isListening) {
            topicInput.value = currentTopic;
            // topicInput.disabled = true; // Optional: disable edit while listening
            actionInput.value = 'stop';
            btn.textContent = 'Stop Listening';
            btn.className = 'btn btn-danger';
        } else {
            topicInput.value = '';
            // topicInput.disabled = false;
            actionInput.value = 'start';
            btn.textContent = 'Start Listening';
            btn.className = 'btn';
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', updateFormState);
</script>
{% endblock %}